name: CI/CD for main branch

on:
    push:

jobs:
    quality:
        name: Quality
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3
            - run: npm run check-code-format

    build:
        name: Build & Test
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3
            - run: npm install
            - run: npm test

    deploy:
        needs: build
        name: Deploy to Heroku
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        steps:
            - uses: actions/checkout@v3
            - uses: akhileshns/heroku-deploy@v3.12.12
              with:
                  heroku_api_key: ${{secrets.HEROKU_API_KEY}}
                  heroku_app_name: 'watchpad-portal'
                  heroku_email: 'devingar18@gmail.com'
                  usedocker: true
    
    deploy-to-s3:
        needs: build
        name: Deploy to s3
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        steps:
            - run: npm install
            - run: npm run build
            - uses: actions/checkout@v3
            - uses: jakejarvis/s3-sync-action@master
              with:
                  args: --acl public-read --delete
              env:
                AWS_S3_BUCKET: ${{ secrets.AWS_PRODUCTION_BUCKET_NAME }}
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                AWS_REGION: ${{ secrets.AWS_REGION }}
                SOURCE_DIR: "./build"